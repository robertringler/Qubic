/*
 * Nextflow Configuration for VITRA-E0 Pipeline
 * =============================================
 * 
 * Defines execution profiles for different compute environments:
 *   - local: Local execution (testing)
 *   - guix: Guix containerized execution (deterministic)
 *   - slurm: SLURM cluster execution
 *   - gpu: GPU acceleration configuration
 *   - airgap: Air-gapped execution (Z3 zone)
 */

// Global parameters
params {
    // Pipeline metadata
    pipeline_name = 'vitra-e0-germline'
    pipeline_version = '1.0.0'
    
    // Default output directory
    outdir = './results'
    
    // Trace and reporting
    tracedir = "${params.outdir}/pipeline_info"
    
    // Resource defaults
    max_cpus = 16
    max_memory = '64.GB'
    max_time = '24.h'
    max_gpus = 1
}

// Process labels and resource requirements
process {
    // Default resources
    cpus = 4
    memory = '16.GB'
    time = '4.h'
    
    // Label-specific resources
    withLabel: 'cpu' {
        cpus = 8
        memory = '32.GB'
        time = '2.h'
    }
    
    withLabel: 'gpu' {
        cpus = 16
        memory = '64.GB'
        time = '8.h'
        clusterOptions = '--gres=gpu:1'
        containerOptions = '--gpus all'
    }
    
    // Process-specific overrides
    withName: 'ALIGN_FQ2BAM' {
        cpus = 16
        memory = '64.GB'
        time = '2.h'
    }
    
    withName: 'CALL_VARIANTS' {
        cpus = 16
        memory = '64.GB'
        time = '2.h'
    }
    
    withName: 'GIAB_VALIDATE' {
        cpus = 8
        memory = '16.GB'
        time = '30.m'
    }
    
    withName: 'PROVENANCE' {
        cpus = 2
        memory = '4.GB'
        time = '10.m'
    }
}

// Execution profiles
profiles {
    // Local execution (for testing)
    local {
        executor {
            name = 'local'
            cpus = params.max_cpus
            memory = params.max_memory
        }
        
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    
    // Guix containerized execution (deterministic)
    guix {
        process.container = 'guix'
        
        // Use Guix time-machine for reproducibility
        containerOptions = '--container --network --share=/tmp'
        
        // Pin Guix channels
        env.GUIX_PACKAGE_PATH = "${projectDir}/../configs/guix_channels.scm"
    }
    
    // GPU acceleration
    gpu {
        docker.enabled = true
        docker.runOptions = '--gpus all --runtime=nvidia'
        
        process {
            withLabel: 'gpu' {
                container = 'nvcr.io/nvidia/clara/clara-parabricks:4.2.1-1'
            }
        }
    }
    
    // SLURM cluster execution
    slurm {
        executor {
            name = 'slurm'
            queueSize = 100
            submitRateLimit = '10/1min'
        }
        
        process {
            executor = 'slurm'
            queue = 'gpu'
            clusterOptions = '--account=genomics --partition=gpu'
        }
        
        singularity.enabled = true
        singularity.autoMounts = true
    }
    
    // Air-gapped execution (Z3 zone)
    airgap {
        executor {
            name = 'local'
        }
        
        // No internet access - all containers must be pre-loaded
        docker.enabled = false
        singularity.enabled = true
        singularity.cacheDir = '/opt/vitra/containers'
        
        // Use local container archive
        process.container = '/opt/vitra/containers/vitra-e0-v1.0.squashfs'
        
        // Disable network access
        containerOptions = '--network none'
    }
    
    // Testing profile (stub execution)
    test {
        params.outdir = './test_results'
        process.stub = true
    }
}

// Execution reporting
timeline {
    enabled = true
    file = "${params.tracedir}/timeline.html"
}

report {
    enabled = true
    file = "${params.tracedir}/report.html"
}

trace {
    enabled = true
    file = "${params.tracedir}/trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file = "${params.tracedir}/dag.svg"
}

// Manifest
manifest {
    name = 'VITRA-E0'
    author = 'QRATUM Platform'
    homePage = 'https://github.com/robertringler/QRATUM'
    description = 'Sovereign Entropy Anchor for Deterministic Genomics'
    mainScript = 'vitra-e0-germline.nf'
    nextflowVersion = '>=23.04.0'
    version = '1.0.0'
}

// Cleanup
cleanup = true

// Resume on failure
resume = true

// Work directory
workDir = './work'

// Container cache
docker {
    enabled = false
    cacheDir = './containers'
}

singularity {
    enabled = false
    cacheDir = './containers'
    autoMounts = true
}
