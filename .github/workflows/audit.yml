name: QuASIM Repository Audit

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'requirements*.txt'

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pip-audit safety

      - name: Run full repository audit
        id: audit
        run: |
          make audit || true
          
      - name: Upload audit summary
        uses: actions/upload-artifact@v4
        with:
          name: audit-summary
          path: audit/audit_summary.json
          retention-days: 90

      - name: Generate audit report
        id: report
        run: |
          python3 -c "
          import json
          from pathlib import Path
          
          summary_file = Path('audit/audit_summary.json')
          if summary_file.exists():
              with open(summary_file) as f:
                  data = json.load(f)
              
              print('# Audit Summary')
              print(f\"Status: {data['overall_status'].upper()}\")
              print(f\"Average Score: {data['average_score']:.1f}/10.0\")
              print(f\"Compliance Coverage: {data['compliance_coverage']:.1f}%\")
              print()
              print('## Check Results')
              for check in data['checks']:
                  status_emoji = '✅' if check['status'] == 'pass' else '⚠️' if check['status'] == 'warn' else '❌'
                  print(f\"{status_emoji} {check['name']}: {check['score']:.1f}/10.0 ({check['findings_count']} findings)\")
              
              # Write to file for GitHub Summary
              with open('audit_report.md', 'w') as out:
                  out.write(f\"# QuASIM Repository Audit Report\\n\\n\")
                  out.write(f\"**Timestamp:** {data['timestamp']}\\n\\n\")
                  out.write(f\"**Overall Status:** {data['overall_status'].upper()}\\n\")
                  out.write(f\"**Average Score:** {data['average_score']:.1f}/10.0\\n\")
                  out.write(f\"**Compliance Coverage:** {data['compliance_coverage']:.1f}%\\n\\n\")
                  out.write(f\"## Check Results\\n\\n\")
                  for check in data['checks']:
                      status_emoji = '✅' if check['status'] == 'pass' else '⚠️' if check['status'] == 'warn' else '❌'
                      out.write(f\"- {status_emoji} **{check['name']}**: {check['score']:.1f}/10.0 ({check['findings_count']} findings)\\n\")
                  
                  if data.get('recommendations'):
                      out.write(f\"\\n## Recommendations\\n\\n\")
                      for rec in data['recommendations']:
                          out.write(f\"- {rec}\\n\")
                  
                  out.write(f\"\\n## Key Metrics\\n\\n\")
                  out.write(f\"- Code Quality: {data['metrics']['code_quality']:.1f}/10.0\\n\")
                  out.write(f\"- Security Vulnerabilities: {data['metrics']['security_vulnerabilities']}\\n\")
                  out.write(f\"- Documentation Errors: {data['metrics']['documentation_errors']}\\n\")
          " | tee audit_report_summary.txt

      - name: Add audit report to job summary
        if: always()
        run: |
          if [ -f audit_report.md ]; then
            cat audit_report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: |
            audit_report.md
            audit_report_summary.txt
          retention-days: 90

      - name: Check audit status
        run: |
          if [ -f audit/audit_summary.json ]; then
            STATUS=$(python3 -c "import json; print(json.load(open('audit/audit_summary.json'))['overall_status'])")
            if [ "$STATUS" = "fail" ]; then
              echo "❌ Audit failed with critical issues"
              exit 1
            elif [ "$STATUS" = "warn" ]; then
              echo "⚠️ Audit passed with warnings"
            else
              echo "✅ Audit passed"
            fi
          fi

      - name: Create Issue on Audit Failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## Audit Failed\n\nThe nightly repository audit has detected critical issues.\n\n';
            
            if (fs.existsSync('audit_report.md')) {
              const report = fs.readFileSync('audit_report.md', 'utf8');
              body += report;
            }
            
            body += '\n\nPlease review the audit findings and address critical issues.';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[AUDIT] Repository Audit Failed - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['audit', 'quality', 'automated']
            });
