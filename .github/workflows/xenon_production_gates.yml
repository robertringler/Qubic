name: XENON Production Gates

on:
  pull_request:
    paths:
      - 'qratum/bioinformatics/**'
      - 'qratum/core/**'
      - 'tests/hardening/xenon_v5/**'
  push:
    branches:
      - main
      - 'copilot/promote-xenon-v5-production'

jobs:
  determinism-gate:
    name: "Gate 1: Determinism"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-prod.txt
          pip install -e .
      
      - name: Run reproducibility tests
        run: |
          pytest tests/hardening/xenon_v5/test_reproducibility.py -v --tb=short
      
      - name: Verify global seed lock
        run: |
          python -c "from qratum.core.reproducibility import get_global_seed; assert get_global_seed() == 42, 'Global seed must be 42'"

  numerical-stability-gate:
    name: "Gate 2: Numerical Stability"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-prod.txt
          pip install -e .
      
      - name: Run numerical stability tests
        run: |
          pytest tests/hardening/xenon_v5/test_numerical_stability.py -v --tb=short
      
      - name: Check for NaN/Inf in outputs
        run: |
          python -c "
          import numpy as np
          from qratum.bioinformatics.xenon.alignment import QuantumAlignmentEngine
          engine = QuantumAlignmentEngine(seed=42)
          result = engine.align('ACGT', 'ACGT')
          assert not np.isnan(result['score']), 'Score contains NaN'
          assert not np.isinf(result['score']), 'Score contains Inf'
          "

  performance-gate:
    name: "Gate 3: Performance"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-prod.txt
          pip install -e .
      
      - name: Run performance tests
        run: |
          pytest tests/hardening/xenon_v5/test_performance.py -v --tb=short
      
      - name: Benchmark alignment performance
        run: |
          python -c "
          import time
          from qratum.bioinformatics.xenon.alignment import QuantumAlignmentEngine
          engine = QuantumAlignmentEngine(seed=42)
          seq1 = 'ACGT' * 25
          seq2 = 'ACGT' * 25
          start = time.perf_counter()
          result = engine.align(seq1, seq2)
          elapsed = time.perf_counter() - start
          print(f'Alignment time: {elapsed:.3f}s')
          assert elapsed < 1.0, f'Performance target not met: {elapsed:.3f}s > 1.0s'
          "

  security-gate:
    name: "Gate 4: Security"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-prod.txt
          pip install -e .
      
      - name: Run security tests
        run: |
          pytest tests/hardening/xenon_v5/test_security.py -v --tb=short
      
      - name: Test input validation
        run: |
          python -c "
          from qratum.core.security import SecurityValidator
          validator = SecurityValidator()
          
          # Test sequence validation
          result = validator.validate_sequence('ACGTXYZ', 'DNA')
          assert not result['valid'], 'Invalid DNA should be rejected'
          
          # Test directory traversal protection
          result = validator.validate_file_path('../../../etc/passwd')
          assert not result['valid'], 'Directory traversal should be blocked'
          "

  load-testing-gate:
    name: "Gate 5: Load Testing"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-prod.txt
          pip install -e .
      
      - name: Run load tests
        run: |
          pytest tests/hardening/xenon_v5/test_load.py -v --tb=short
      
      - name: Test concurrent operations
        run: |
          python -c "
          from concurrent.futures import ThreadPoolExecutor
          from qratum.bioinformatics.xenon.alignment import QuantumAlignmentEngine
          
          engine = QuantumAlignmentEngine(seed=42)
          
          def align_task(i):
              result = engine.align('ACGT' * 10, 'ACGT' * 10)
              return result['score']
          
          with ThreadPoolExecutor(max_workers=4) as executor:
              results = list(executor.map(align_task, range(10)))
          
          assert len(results) == 10, 'All tasks should complete'
          assert all(score > 0 for score in results), 'All scores should be valid'
          "

  integration-gate:
    name: "Gate 6: Integration"
    runs-on: ubuntu-latest
    needs: [determinism-gate, numerical-stability-gate, performance-gate, security-gate, load-testing-gate]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-prod.txt
          pip install -e .
      
      - name: Run full hardening test suite
        run: |
          pytest tests/hardening/xenon_v5/ -v --tb=short --cov=qratum --cov-report=term-missing
      
      - name: Verify all engines
        run: |
          python -c "
          # Test alignment engine
          from qratum.bioinformatics.xenon.alignment import QuantumAlignmentEngine
          engine1 = QuantumAlignmentEngine(seed=42)
          result1 = engine1.align('ACGT', 'ACGT')
          assert 'score' in result1
          
          # Test information engine
          import numpy as np
          from qratum.bioinformatics.xenon.omics import InformationEngine
          engine2 = InformationEngine(seed=42)
          data_x = np.random.randn(50, 1)
          data_y = np.random.randn(50, 1)
          result2 = engine2.compute_mutual_information(data_x, data_y)
          assert 'mutual_information' in result2
          
          # Test neural-symbolic reasoner
          from qratum.bioinformatics.xenon.inference import NeuralSymbolicReasoner
          engine3 = NeuralSymbolicReasoner(seed=42, enable_neural=False)
          result3 = engine3.reason('test query')
          assert 'trace' in result3
          
          print('✓ All engines verified')
          "
      
      - name: Generate compliance report
        run: |
          echo "# XENON v5 Production Gates - All Passed" > GATES_REPORT.md
          echo "" >> GATES_REPORT.md
          echo "**Date:** $(date)" >> GATES_REPORT.md
          echo "**Certificate:** QRATUM-HARDENING-20251215-V5" >> GATES_REPORT.md
          echo "" >> GATES_REPORT.md
          echo "## Gate Results" >> GATES_REPORT.md
          echo "- ✅ Determinism Gate" >> GATES_REPORT.md
          echo "- ✅ Numerical Stability Gate" >> GATES_REPORT.md
          echo "- ✅ Performance Gate" >> GATES_REPORT.md
          echo "- ✅ Security Gate" >> GATES_REPORT.md
          echo "- ✅ Load Testing Gate" >> GATES_REPORT.md
          echo "- ✅ Integration Gate" >> GATES_REPORT.md
          cat GATES_REPORT.md
