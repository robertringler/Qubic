name: Code Review & Auto-Fix

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  code-review-and-fix:
    name: Automated Code Review & Fix
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort mypy pylint bandit safety
          pip install numpy || true
          if [ -f docker/requirements.txt ]; then
            pip install -r docker/requirements.txt || true
          fi
      
      - name: Run security checks
        id: security
        run: |
          echo "## Security Scan Results" > security-report.md
          
          # Check for secrets
          echo "### Secret Detection" >> security-report.md
          if git grep -i -E '(password|secret|api_key|token|aws_access_key).*=.*["\047][^"\047]+["\047]' || true; then
            echo "âš ï¸ Potential secrets found - manual review required" >> security-report.md
          else
            echo "âœ… No obvious secrets detected" >> security-report.md
          fi
          
          # Run bandit for Python security issues
          echo "### Python Security Issues (Bandit)" >> security-report.md
          bandit -r . -f txt --severity-level medium -ll || echo "âœ… No critical security issues found" >> security-report.md
          
          cat security-report.md
        continue-on-error: true
      
      - name: Auto-fix code with ruff
        id: ruff-fix
        run: |
          echo "Running ruff auto-fix..."
          python -m ruff check . --fix --show-fixes || true
          
          # Check if changes were made
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No ruff fixes needed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Applied ruff auto-fixes"
          fi
      
      - name: Auto-format with black
        id: black-fix
        run: |
          echo "Running black formatter..."
          python -m black . || true
          
          # Check if changes were made
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No black formatting needed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Applied black formatting"
          fi
      
      - name: Sort imports with isort
        id: isort-fix
        run: |
          echo "Running isort..."
          python -m isort . || true
          
          # Check if changes were made
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No import sorting needed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Sorted imports with isort"
          fi
      
      - name: Check remaining issues
        id: check-issues
        run: |
          echo "## Remaining Code Quality Issues" > issues-report.md
          
          # Ruff check
          echo "### Ruff Linting" >> issues-report.md
          python -m ruff check . --statistics >> issues-report.md 2>&1 || true
          
          # Mypy type checking
          echo "### Type Checking (mypy)" >> issues-report.md
          python -m mypy --ignore-missing-imports . >> issues-report.md 2>&1 || echo "Type checking completed" >> issues-report.md
          
          cat issues-report.md
        continue-on-error: true
      
      - name: Commit auto-fixes
        id: commit-fixes
        if: github.event_name == 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git add -A
            git commit -m "chore: auto-fix code quality issues" \
                       -m "" \
                       -m "- Applied ruff auto-fixes" \
                       -m "- Formatted code with black" \
                       -m "- Sorted imports with isort" \
                       -m "" \
                       -m "Auto-generated by code-review-autofix workflow"
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
            echo "âœ… Committed and pushed auto-fixes"
          fi
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.commit-fixes.outputs.committed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = `## ðŸ¤– Automated Code Quality Fixes Applied\n\n`;
            comment += `I've automatically fixed code quality issues in this PR:\n\n`;
            comment += `- âœ… Applied ruff linting auto-fixes\n`;
            comment += `- âœ… Formatted code with black\n`;
            comment += `- âœ… Sorted imports with isort\n\n`;
            
            if (fs.existsSync('security-report.md')) {
              const securityReport = fs.readFileSync('security-report.md', 'utf8');
              comment += `\n### Security Scan\n${securityReport}\n`;
            }
            
            if (fs.existsSync('issues-report.md')) {
              const issuesReport = fs.readFileSync('issues-report.md', 'utf8');
              comment += `\n### Remaining Issues\n${issuesReport}\n`;
            }
            
            comment += `\n---\n*The changes have been automatically committed to this PR.*`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            security-report.md
            issues-report.md
          retention-days: 30
