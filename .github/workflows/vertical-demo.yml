name: Vertical Market Demos

on:
  push:
    branches:
      - pilot/market-verticals
      - copilot/add-vertical-specific-demos
  workflow_dispatch:

jobs:
  vertical-demos:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install demo dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-demo.txt

      - name: Run Aerospace demo
        run: |
          python demos/quasim_aerospace_demo.py --profile configs/vertical_profiles/aerospace_f9.json --generations 50 --pop 20 --seed 42

      - name: Run Telecom demo
        run: |
          python demos/quasim_telecom_demo.py --profile configs/vertical_profiles/telecom_constellation.json --generations 50 --pop 20 --seed 42

      - name: Run Finance demo
        run: |
          python demos/quasim_finance_demo.py --profile configs/vertical_profiles/finance_var.json --generations 50 --pop 20 --seed 42

      - name: Run Healthcare demo
        run: |
          python demos/quasim_healthcare_demo.py --profile configs/vertical_profiles/healthcare_genomics.json --generations 50 --pop 20 --seed 42

      - name: Run Energy demo
        run: |
          python demos/quasim_energy_demo.py --profile configs/vertical_profiles/energy_grid.json --generations 50 --pop 20 --seed 42

      - name: Run Transportation demo
        run: |
          python demos/quasim_transportation_demo.py --profile configs/vertical_profiles/transportation_logistics.json --generations 50 --pop 20 --seed 42

      - name: Run Manufacturing demo
        run: |
          python demos/quasim_manufacturing_demo.py --profile configs/vertical_profiles/manufacturing_iiot.json --generations 50 --pop 20 --seed 42

      - name: Run Agritech demo
        run: |
          python demos/quasim_agritech_demo.py --profile configs/vertical_profiles/agritech_optimization.json --generations 50 --pop 20 --seed 42

      - name: Verify output files
        run: |
          echo "Checking output files..."
          ls -lh *_demo_report.json
          
          # Verify JSON structure for each vertical
          for report in aerospace_f9_demo_report.json telecom_constellation_demo_report.json finance_var_demo_report.json healthcare_genomics_demo_report.json energy_grid_demo_report.json transportation_logistics_demo_report.json manufacturing_iiot_demo_report.json agritech_optimization_demo_report.json; do
            echo "Validating $report..."
            python -c "import json; with open('$report') as f: data=json.load(f); assert 'optimized_alpha' in data; assert 'fitness_rmse' in data; assert 'compliance_tags' in data; assert 'vertical' in data; print(f'✓ {data[\"vertical\"]}: alpha={data[\"optimized_alpha\"]:.6f}, fitness={data[\"fitness_rmse\"]:.6f}, compliance={len(data[\"compliance_tags\"])} tags')"
          done

      - name: Upload Aerospace demo report
        uses: actions/upload-artifact@v4
        with:
          name: aerospace_demo_report
          path: aerospace_f9_demo_report.json
          retention-days: 90

      - name: Upload Telecom demo report
        uses: actions/upload-artifact@v4
        with:
          name: telecom_demo_report
          path: telecom_constellation_demo_report.json
          retention-days: 90

      - name: Upload Finance demo report
        uses: actions/upload-artifact@v4
        with:
          name: finance_demo_report
          path: finance_var_demo_report.json
          retention-days: 90

      - name: Upload Healthcare demo report
        uses: actions/upload-artifact@v4
        with:
          name: healthcare_demo_report
          path: healthcare_genomics_demo_report.json
          retention-days: 90

      - name: Upload Energy demo report
        uses: actions/upload-artifact@v4
        with:
          name: energy_demo_report
          path: energy_grid_demo_report.json
          retention-days: 90

      - name: Upload Transportation demo report
        uses: actions/upload-artifact@v4
        with:
          name: transportation_demo_report
          path: transportation_logistics_demo_report.json
          retention-days: 90

      - name: Upload Manufacturing demo report
        uses: actions/upload-artifact@v4
        with:
          name: manufacturing_demo_report
          path: manufacturing_iiot_demo_report.json
          retention-days: 90

      - name: Upload Agritech demo report
        uses: actions/upload-artifact@v4
        with:
          name: agritech_demo_report
          path: agritech_optimization_demo_report.json
          retention-days: 90

      - name: Generate summary
        run: |
          echo "## QuASIM Vertical Market Demo Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Vertical | Alpha | Fitness (RMSE) | Fidelity | Compliance Tags |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|----------------|----------|-----------------|" >> $GITHUB_STEP_SUMMARY
          
          for report in aerospace_f9_demo_report.json telecom_constellation_demo_report.json finance_var_demo_report.json healthcare_genomics_demo_report.json energy_grid_demo_report.json transportation_logistics_demo_report.json manufacturing_iiot_demo_report.json agritech_optimization_demo_report.json; do
            python -c "import json; with open('$report') as f: data=json.load(f); print(f'| {data[\"vertical\"].title()} | {data[\"optimized_alpha\"]:.6f} | {data[\"fitness_rmse\"]:.6f} | {data[\"validation_metrics\"][\"fidelity\"]:.4f} | {len(data[\"compliance_tags\"])} |')" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All demos completed**: < 60s per demo (deterministic, CPU-only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Compliance Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **Aerospace**: DO-178C Level A, ITAR, NASA-STD-8739.8" >> $GITHUB_STEP_SUMMARY
          echo "- **Telecom**: FCC Part 25, ITU Radio Regulations, 3GPP TS 38.821" >> $GITHUB_STEP_SUMMARY
          echo "- **Finance**: PCI DSS, SOX, Basel III, MiFID II" >> $GITHUB_STEP_SUMMARY
          echo "- **Healthcare**: HIPAA, CLIA, CAP, FDA 21 CFR Part 11" >> $GITHUB_STEP_SUMMARY
          echo "- **Energy**: NERC CIP, IEEE 1547, FERC Order 2222, IEC 61850" >> $GITHUB_STEP_SUMMARY
          echo "- **Transportation**: DOT FMCSA, CARB, EPA SmartWay, ISO 28000" >> $GITHUB_STEP_SUMMARY
          echo "- **Manufacturing**: ISO 9001, ISA-95, IEC 62443, OSHA" >> $GITHUB_STEP_SUMMARY
          echo "- **Agritech**: EPA FIFRA, FDA FSMA, USDA Organic, GAP" >> $GITHUB_STEP_SUMMARY
